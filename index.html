<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Snoopy's Fukuoka 2026 (App)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-color: #F8F9FA;
            --paper-color: #FFFFFF;
            --ink-black: #1a1a1a;
            --snoopy-red: #E12120;
            --woodstock-yellow: #FFCE00;
            --sky-blue: #87CEEB;
            --starlux-gold: #B59E68;
            --booking-blue: #003580;
            --luxury-purple: #6A1B9A;
            --konbini-green: #27AE60;
            --border-thick: 3px solid var(--ink-black);
            --shadow-hard: 4px 4px 0px var(--ink-black);
            --radius-comic: 12px;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--ink-black) 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Patrick Hand', 'Zen Maru Gothic', cursive;
            color: var(--ink-black);
            -webkit-tap-highlight-color: transparent;
        }

        /* Comic Style Utilities */
        .comic-panel {
            background: var(--paper-color);
            border: var(--border-thick);
            border-radius: var(--radius-comic);
            box-shadow: var(--shadow-hard);
        }
        .comic-btn {
            transition: all 0.1s;
        }
        .comic-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px var(--ink-black) !important;
        }

        /* Leaflet Fixes */
        .leaflet-container {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            border: 3px solid #1a1a1a;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Mock Data (Initial State) ---
        const INITIAL_ITINERARY = [
            { id: '1-1', day: 1, time: '09:35', title: 'æ˜Ÿå®‡ JX840 èµ·é£›', type: 'flight', lat: 25.079, lng: 121.234, notes: 'TPE ä¸€èˆªå»ˆå‡ºç™¼', rating: 0 },
            { id: '1-2', day: 1, time: '12:55', title: 'æŠµé”ç¦å²¡æ©Ÿå ´', type: 'flight', lat: 33.585, lng: 130.444, notes: 'æ­è¨ˆç¨‹è»Šå»é£¯åº—ç´„15åˆ† (Â¥1600)', rating: 4.1 },
            { id: '1-3', day: 1, time: '14:00', title: 'åšå¤šå¾®ç¬‘é…’åº— (å¯„è¡Œæ)', type: 'hotel', lat: 33.589, lng: 130.419, notes: 'Check-in 15:00å¾Œ', rating: 0 },
            { id: '1-4', day: 1, time: '15:30', title: 'Mignon å°å¯é Œ', type: 'food', lat: 33.590, lng: 130.420, notes: 'å·§å…‹åŠ›/åœ°ç“œå£å‘³å¿…è²·', rating: 4.2 },
            { id: '1-5', day: 1, time: '18:30', title: 'ç‰›è…¸é‹ å¤§å±± (Oyama)', type: 'food', lat: 33.589, lng: 130.420, notes: 'KITTE 9F | æ¿ƒéƒå‘³å™Œæ¹¯åº•', rating: 4.1 },
            { id: '2-1', day: 2, time: '09:30', title: 'æ«›ç”°ç¥ç¤¾', type: 'spot', lat: 33.593, lng: 130.410, notes: 'åšå¤šç¸½é®å®ˆï¼Œçœ‹å·¨å¤§é£¾å±±ç¬ ', rating: 4.4 },
            { id: '2-2', day: 2, time: '12:30', title: 'å·ç«¯å•†åº—è¡—åˆé¤', type: 'food', lat: 33.594, lng: 130.408, notes: 'æ¨è–¦ï¼šåšå¤šé”æ‘©æ‹‰éºµæˆ–Karoçƒé¾éºµ', rating: 3.9 },
            { id: '2-3', day: 2, time: '14:30', title: 'åšå¤šé‹æ²³åŸ', type: 'spot', lat: 33.589, lng: 130.411, notes: 'B1å™´æ°´ç§€ã€å‰åœåŠ›å•†åº—', rating: 4.0 },
            { id: '2-4', day: 2, time: '18:00', title: 'ä¸­æ´²å±‹å°è¡—', type: 'spot', lat: 33.591, lng: 130.407, notes: 'é‚£ç‚å·é‚Šæ•£æ­¥ï¼Œæ„Ÿå—æ°£æ°›', rating: 3.8 },
            { id: '3-1', day: 3, time: '09:00', title: 'è²·ä¾¿ç•¶ (Ippiné€š)', type: 'food', lat: 33.590, lng: 130.420, notes: 'åšå¤šç«™è²·Yamayaé£¯ç³°', rating: 4.0 },
            { id: '3-2', day: 3, time: '10:00', title: 'æµ·æ´‹ä¸–ç•Œæµ·ä¹‹ä¸­é“', type: 'spot', lat: 33.660, lng: 130.363, notes: 'æµ·è±šç§€å¿…çœ‹', rating: 4.3 },
            { id: '3-3', day: 3, time: '13:00', title: 'æµ·æ¿±å…¬åœ’ (é‡é¤)', type: 'spot', lat: 33.655, lng: 130.360, notes: 'ç²‰è¶èŠ±æµ·ï¼Œç§Ÿè…³è¸è»Š', rating: 4.4 },
            { id: '3-4', day: 3, time: '18:30', title: 'åšå¤šè¯å‘³é³¥', type: 'food', lat: 33.591, lng: 130.418, notes: 'æ°´ç‚Šé›è‚‰é‹æš–èƒƒ', rating: 4.1 },
            { id: '4-1', day: 4, time: '09:30', title: 'å¤ªå®°åºœå¤©æ»¿å®®', type: 'spot', lat: 33.521, lng: 130.534, notes: 'æ‘¸å¾¡ç¥ç‰›ï¼Œè²·æ¢…æé¤…', rating: 4.5 },
            { id: '4-2', day: 4, time: '12:00', title: 'ä¸€è˜­ (å¤ªå®°åºœåº—)', type: 'food', lat: 33.520, lng: 130.533, notes: 'å…¨æ—¥æœ¬å”¯ä¸€äº”è§’åˆæ ¼ç¢—', rating: 4.3 },
            { id: '4-3', day: 4, time: '15:00', title: 'å¤©ç¥åœ°ä¸‹è¡—', type: 'spot', lat: 33.590, lng: 130.398, notes: 'åƒRINGOè˜‹æœæ´¾', rating: 4.2 },
            { id: '4-4', day: 4, time: '18:30', title: 'è‘«è˜†å£½å¸', type: 'food', lat: 33.589, lng: 130.399, notes: 'å¤©ç¥CPå€¼æœ€é«˜è¿´è½‰å£½å¸', rating: 4.3 },
            { id: '5-1', day: 5, time: '08:00', title: 'Tanya ç‰›èˆŒæ—©é¤', type: 'food', lat: 33.590, lng: 130.420, notes: 'åšå¤šä¸€ç•ªè¡—ï¼ŒåŠ é»æ˜å¤ªå­', rating: 4.2 },
            { id: '5-2', day: 5, time: '10:00', title: 'Ming ååº—è¡—æ¡è²·', type: 'spot', lat: 33.590, lng: 130.421, notes: 'è²·é€šé¥…é ­ã€åŠªåŠªé›', rating: 4.1 },
            { id: '5-3', day: 5, time: '12:00', title: 'å‰å¾€æ©Ÿå ´', type: 'flight', lat: 33.585, lng: 130.444, notes: 'JX841 14:15 èµ·é£›', rating: 0 },
        ];

        // --- Data Hook (Hybrid: Firebase + Local) ---
        const useDataLayer = (collectionName, initialData = []) => {
            const [data, setData] = useState(initialData);
            const [isCloud, setIsCloud] = useState(false);

            // Check Firebase availability
            const firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : null;
            const hasApiKey = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey.length > 0;

            useEffect(() => {
                if (hasApiKey) {
                    try {
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        const db = firebase.firestore();
                        const auth = firebase.auth();
                        
                        // Auth & Listen
                        auth.onAuthStateChanged(async (user) => {
                            if (!user) {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await auth.signInWithCustomToken(__initial_auth_token);
                                } else {
                                    await auth.signInAnonymously();
                                }
                            }
                            const appId = (typeof __app_id !== 'undefined') ? __app_id : 'snoopy-trip-2026';
                            const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName);
                            
                            ref.onSnapshot(snapshot => {
                                if (snapshot.empty && initialData.length > 0) {
                                    // Seed initial data to cloud if empty
                                    initialData.forEach(item => ref.add(item));
                                } else {
                                    const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    setData(docs);
                                    setIsCloud(true);
                                }
                            });
                        });
                    } catch (e) {
                        console.warn("Cloud connect failed, using local mode", e);
                    }
                }
            }, [collectionName]);

            // Actions
            const addItem = async (item) => {
                if (isCloud) {
                    const appId = (typeof __app_id !== 'undefined') ? __app_id : 'snoopy-trip-2026';
                    await firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName).add(item);
                } else {
                    const newItem = { ...item, id: Date.now().toString() };
                    setData(prev => [...prev, newItem]);
                }
            };

            const deleteItem = async (id) => {
                if (isCloud) {
                    const appId = (typeof __app_id !== 'undefined') ? __app_id : 'snoopy-trip-2026';
                    await firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName).doc(id).delete();
                } else {
                    setData(prev => prev.filter(i => i.id !== id));
                }
            };

            const updateItem = async (id, item) => {
                if (isCloud) {
                    const appId = (typeof __app_id !== 'undefined') ? __app_id : 'snoopy-trip-2026';
                    await firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName).doc(id).update(item);
                } else {
                    setData(prev => prev.map(i => i.id === id ? { ...i, ...item } : i));
                }
            };

            return { data, isCloud, addItem, deleteItem, updateItem };
        };

        // --- Icons ---
        const Icons = {
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Cloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>,
            WifiOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>
        };

        // --- Weather Widget ---
        const WeatherWidget = () => {
            const [weather, setWeather] = useState(null);
            useEffect(() => {
                fetch('https://api.open-meteo.com/v1/forecast?latitude=33.5902&longitude=130.4017&current_weather=true')
                    .then(res => res.json()).then(data => setWeather(data.current_weather)).catch(console.error);
            }, []);
            if (!weather) return <div className="text-sm text-gray-500 p-2">â˜ï¸ è¼‰å…¥å¤©æ°£ä¸­...</div>;
            return (
                <div className="comic-panel mb-4 p-3 flex justify-between items-center bg-blue-100 text-blue-800">
                    <span className="font-bold text-lg">åšå¤šå³æ™‚</span>
                    <span className="text-2xl font-bold">{weather.temperature}Â°C</span>
                </div>
            );
        };

        // --- Map Component ---
        const MapComponent = ({ items }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef([]);

            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;
                const map = L.map(mapRef.current).setView([33.5902, 130.4017], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
                mapInstanceRef.current = map;
            }, []);

            useEffect(() => {
                const map = mapInstanceRef.current;
                if (!map) return;
                markersRef.current.forEach(m => map.removeLayer(m));
                markersRef.current = [];
                
                if (items.length === 0) return;
                
                const group = new L.FeatureGroup();
                items.forEach(item => {
                    if (item.lat && item.lng) {
                        const marker = L.marker([item.lat, item.lng]).bindPopup(`<b>${item.title}</b><br>${item.time}`);
                        marker.addTo(map);
                        group.addLayer(marker);
                        markersRef.current.push(marker);
                    }
                });
                
                if (markersRef.current.length > 0) map.fitBounds(group.getBounds().pad(0.1));
            }, [items]);

            const locateMe = () => {
                const map = mapInstanceRef.current;
                if (map) {
                    map.locate({setView: true, maxZoom: 16});
                    map.once('locationfound', (e) => {
                        L.circle(e.latlng, e.accuracy).addTo(map);
                        L.marker(e.latlng).addTo(map).bindPopup("æˆ‘åœ¨é€™!").openPopup();
                    });
                }
            };

            return (
                <div className="relative w-full h-96">
                    <div ref={mapRef} className="w-full h-full rounded-xl border-4 border-gray-900 shadow-lg"></div>
                    <button onClick={locateMe} className="absolute bottom-4 right-4 z-[500] bg-yellow-400 text-black p-2 rounded-full border-2 border-black shadow-lg font-bold comic-btn">ğŸ“ å®šä½</button>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [currentTab, setCurrentTab] = useState('itinerary');
            const [day, setDay] = useState(1);
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            const [editItem, setEditItem] = useState(null);

            // Hybrid Data Handling
            const { data: itineraryData, isCloud: itinIsCloud, addItem: addItin, deleteItem: deleteItin, updateItem: updateItin } = useDataLayer('itinerary', INITIAL_ITINERARY);
            const { data: expenseData, isCloud: expIsCloud, addItem: addExp, deleteItem: deleteExp } = useDataLayer('expenses', []);

            // Handlers
            const handleSaveItem = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const item = {
                    day: parseInt(formData.get('day')),
                    time: formData.get('time'),
                    title: formData.get('title'),
                    notes: formData.get('notes'),
                    type: 'custom',
                    lat: 33.5902, lng: 130.4017, // Default
                    rating: 0
                };
                if(editItem) await updateItin(editItem.id, item);
                else await addItin(item);
                setIsEditModalOpen(false);
            };

            const handleAddExpense = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                await addExp({
                    item: formData.get('item'),
                    amount: parseFloat(formData.get('amount')),
                    payer: formData.get('payer')
                });
                e.target.reset();
            };

            const currentItems = itineraryData.filter(i => i.day === day).sort((a,b) => a.time.localeCompare(b.time));
            
            const settlement = expenseData.reduce((acc, curr) => {
                acc.total += curr.amount;
                acc.payMap[curr.payer] = (acc.payMap[curr.payer] || 0) + curr.amount;
                return acc;
            }, { total: 0, payMap: {} });

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24">
                    {/* Header */}
                    <div className="sticky top-0 z-50 bg-white border-b-4 border-black p-4 text-center shadow-md">
                        <div className="inline-block bg-white border-2 border-black rounded-lg px-6 py-2 shadow-[4px_4px_0px_#1a1a1a]">
                            <h1 className="text-2xl font-bold">FUKUOKA TRIP ğŸ¾</h1>
                        </div>
                        <div className="mt-2 flex justify-center items-center gap-2">
                            {itinIsCloud ? 
                                <span className="bg-green-100 text-green-800 border-2 border-green-600 rounded-full px-3 py-1 text-xs font-bold flex items-center gap-1"><Icons.Cloud/> é›²ç«¯åŒæ­¥ä¸­</span> : 
                                <span className="bg-gray-100 text-gray-600 border-2 border-gray-400 rounded-full px-3 py-1 text-xs font-bold flex items-center gap-1"><Icons.WifiOff/> å–®æ©Ÿæ¨¡å¼</span>
                            }
                        </div>
                    </div>

                    <div className="p-4">
                        {/* TAB: ITINERARY */}
                        {currentTab === 'itinerary' && (
                            <>
                                <div className="flex overflow-x-auto gap-3 pb-4 mb-2 no-scrollbar">
                                    {[1,2,3,4,5].map(d => (
                                        <button key={d} onClick={() => setDay(d)} className={`flex-shrink-0 min-w-[80px] border-4 border-black rounded-2xl p-2 text-center transition-all ${day === d ? 'bg-[#E12120] text-white shadow-[4px_4px_0px_#1a1a1a] -translate-y-1' : 'bg-white text-black'}`}>
                                            <div className="font-bold text-lg">Day {d}</div>
                                        </button>
                                    ))}
                                </div>
                                <WeatherWidget />
                                <div className="space-y-4">
                                    {currentItems.map(item => (
                                        <div key={item.id} className="comic-panel p-4 relative group">
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="bg-black text-white px-2 py-1 rounded text-sm font-bold transform -rotate-1">{item.time}</span>
                                                <div className="flex gap-2">
                                                    <button onClick={() => { setEditItem(item); setIsEditModalOpen(true); }} className="text-gray-500"><Icons.Edit /></button>
                                                    <button onClick={() => deleteItin(item.id)} className="text-red-500"><Icons.Trash /></button>
                                                </div>
                                            </div>
                                            <h3 className="text-xl font-bold mb-2">{item.title} {item.rating > 0 && <span className="text-xs bg-yellow-100 px-1 rounded">â­{item.rating}</span>}</h3>
                                            <div className="bg-yellow-50 border-2 border-dashed border-black rounded-lg p-3 text-sm relative mt-3 mb-2">
                                                <div className="absolute -top-3 left-2 bg-yellow-400 border-2 border-black rounded px-2 text-xs font-bold transform -rotate-2">ğŸ’¡ Note</div>
                                                {item.notes}
                                            </div>
                                            <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title + ' ç¦å²¡')}`} target="_blank" className="mt-2 w-full bg-yellow-400 text-black border-2 border-black rounded-lg py-2 flex justify-center items-center font-bold shadow-sm comic-btn">ğŸ“ å°èˆª</a>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => { setEditItem(null); setIsEditModalOpen(true); }} className="fixed bottom-24 right-4 bg-black text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-2 border-white z-40 comic-btn"><Icons.Plus /></button>
                            </>
                        )}

                        {/* TAB: MAP */}
                        {currentTab === 'map' && (
                            <div className="h-[calc(100vh-200px)]">
                                <h2 className="text-xl font-bold mb-4 text-center">Day {day} è¶³è·¡åœ°åœ–</h2>
                                <MapComponent items={currentItems} />
                            </div>
                        )}

                        {/* TAB: EXPENSE */}
                        {currentTab === 'expense' && (
                            <div>
                                <h2 className="text-xl font-bold mb-4 bg-yellow-400 inline-block px-3 border-2 border-black rounded transform -rotate-1">ğŸ’° åˆ†å¸³å°å¹«æ‰‹</h2>
                                <div className="comic-panel p-4 mb-6">
                                    <form onSubmit={handleAddExpense} className="space-y-3">
                                        <input name="item" placeholder="é …ç›®" required className="w-full border-2 border-gray-300 rounded p-2" />
                                        <div className="flex gap-2">
                                            <input name="amount" type="number" placeholder="Â¥" required className="w-1/2 border-2 border-gray-300 rounded p-2" />
                                            <select name="payer" className="w-1/2 border-2 border-gray-300 rounded p-2">
                                                <option value="æˆ‘">æˆ‘</option><option value="å‹A">å‹A</option><option value="å‹B">å‹B</option>
                                            </select>
                                        </div>
                                        <button type="submit" className="w-full bg-black text-white font-bold py-2 rounded">è¨˜å¸³</button>
                                    </form>
                                </div>
                                <div className="space-y-2 mb-6">
                                    {expenseData.map(exp => (
                                        <div key={exp.id} className="flex justify-between items-center bg-white border border-gray-200 p-3 rounded">
                                            <div><div className="font-bold">{exp.item}</div><div className="text-xs text-gray-500">{exp.payer} å…ˆä»˜</div></div>
                                            <div className="flex items-center gap-3"><span className="font-bold">Â¥{exp.amount}</span><button onClick={() => deleteExp(exp.id)} className="text-red-500"><Icons.Trash/></button></div>
                                        </div>
                                    ))}
                                </div>
                                <div className="bg-blue-50 border-2 border-blue-900 rounded-xl p-4">
                                    <div className="flex justify-between mb-1"><span>ç¸½èŠ±è²»:</span> <span className="font-bold">Â¥{settlement.total}</span></div>
                                    {Object.entries(settlement.payMap).map(([k,v]) => <div key={k} className="flex justify-between text-sm"><span>{k}:</span><span>Â¥{v}</span></div>)}
                                </div>
                            </div>
                        )}

                        {/* TAB: KONBINI */}
                        {currentTab === 'konbini' && (
                            <div className="text-center py-10">
                                <h2 className="text-2xl font-bold mb-4">ğŸª è¶…å•†ç¥å™¨</h2>
                                <p className="text-gray-600 mb-6">è«‹ä½¿ç”¨ Google åœ–ç‰‡æœå°‹åŠŸèƒ½ã€‚</p>
                                <button onClick={() => window.open('https://www.google.com/search?q=æ—¥æœ¬è¶…å•†å¿…è²·2026&tbm=isch', '_blank')} className="bg-green-500 text-white px-6 py-3 rounded-full font-bold border-2 border-black shadow-[4px_4px_0px_#000]">ğŸ” æœå°‹å¿…è²·æ¸…å–®</button>
                            </div>
                        )}
                    </div>

                    {/* Edit Modal */}
                    {isEditModalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000] p-4">
                            <div className="bg-white rounded-xl border-4 border-black p-6 w-full max-w-sm shadow-2xl relative">
                                <button onClick={() => setIsEditModalOpen(false)} className="absolute top-2 right-2 text-2xl font-bold">&times;</button>
                                <h2 className="text-xl font-bold mb-4">{editItem ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹'}</h2>
                                <form onSubmit={handleSaveItem} className="space-y-3">
                                    <div className="flex gap-2">
                                        <select name="day" defaultValue={editItem?.day || day} className="border-2 border-gray-300 rounded p-2 w-1/3">{[1,2,3,4,5].map(d => <option key={d} value={d}>Day {d}</option>)}</select>
                                        <input name="time" type="time" defaultValue={editItem?.time} required className="border-2 border-gray-300 rounded p-2 w-2/3" />
                                    </div>
                                    <input name="title" defaultValue={editItem?.title} placeholder="æ¨™é¡Œ" required className="w-full border-2 border-gray-300 rounded p-2" />
                                    <textarea name="notes" defaultValue={editItem?.notes} placeholder="å‚™è¨»" rows="3" className="w-full border-2 border-gray-300 rounded p-2"></textarea>
                                    <button type="submit" className="w-full bg-yellow-400 text-black font-bold py-3 rounded-lg border-2 border-black shadow-[2px_2px_0px_#000]">å„²å­˜</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Bottom Nav */}
                    <div className="fixed bottom-0 left-0 right-0 h-[70px] bg-white border-t-[3px] border-black flex justify-around items-center z-50 pb-safe">
                        <button onClick={() => setCurrentTab('itinerary')} className={`flex flex-col items-center ${currentTab === 'itinerary' ? 'text-[#E12120]' : 'text-gray-400'}`}><span className="text-2xl mb-1">ğŸ¦´</span><span className="text-xs font-bold">è¡Œç¨‹</span></button>
                        <button onClick={() => setCurrentTab('map')} className={`flex flex-col items-center ${currentTab === 'map' ? 'text-[#E12120]' : 'text-gray-400'}`}><span className="text-2xl mb-1">ğŸ—ºï¸</span><span className="text-xs font-bold">åœ°åœ–</span></button>
                        <button onClick={() => setCurrentTab('expense')} className={`flex flex-col items-center ${currentTab === 'expense' ? 'text-[#E12120]' : 'text-gray-400'}`}><span className="text-2xl mb-1">ğŸ’°</span><span className="text-xs font-bold">åˆ†å¸³</span></button>
                        <button onClick={() => setCurrentTab('konbini')} className={`flex flex-col items-center ${currentTab === 'konbini' ? 'text-[#E12120]' : 'text-gray-400'}`}><span className="text-2xl mb-1">ğŸª</span><span className="text-xs font-bold">è¶…å•†</span></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
